{
	"name": "SQL script 10",
	"properties": {
		"content": {
			"query": "SET ANSI_NULLS ON\nGO\nSET QUOTED_IDENTIFIER ON\nGO\n\nCREATE PROC [QA_Landing].[VALIDATEDATASERIALSONTRANSIT_OLD] AS\n\n/******\n\n\n\nAutor: Abraham D. Sánchez bSide\nCreatedDate: 2022-10-12\nModifiedDate: 2022-10-12\nModifiedBy: Abraham D. Sánchez bSide\nDescription: Create SP VALIDATEDATASERIALSONTRANSIT\n\n\n\n******/\n\n    DECLARE @logid AS BIGINT = CONVERT(VARCHAR(15),\n                               FORMAT(Getdate(), 'yyMMddHHmmssmmm'))\n\n    EXEC [DBO].[GEN_SPLOGINSERTS]\n      '05 VALIDATEDATASERIALSONTRANSIT',\n      'Execute insert table VALIDATEDATASERIALSONTRANSIT',\n      @logid\n\n    DECLARE @result        VARCHAR (5000) = '',\n            @code          INT,\n            @state         INT,\n            @message       VARCHAR (5000) = '',\n            @stacktracetxt INT\n\n  BEGIN TRY\n\n  truncate table [QA_LANDING].[TMP_STREAM_SERIALS_IN_TRANSIT]\n\n      INSERT INTO [QA_LANDING].[TMP_STREAM_SERIALS_IN_TRANSIT]\n                  ([SERIES],\n                   [STATUS],\n                   [ID],\n                   [DESCRIPTION],\n                   [SOURCE_WAREHOUSE],\n                   [SOURCE_SUB_INVENTORY],\n                   [DESTINATION_WAREHOUSE],\n                   [DESTINATION_SUB_INVENTORY],\n                   [TRANSACTION_DATE],\n                   [SHIPPING_NUMBER],\n                   [FILE_NAME],\n                   [CREATE_DATE])\n      (SELECT [SERIE],\n              [STATUS],\n              [ARTICULO],\n              [DESCRIPCION],\n              [ALMACEN_ORIGEN],\n              [SUB_INVENTARIO_ORIGEN],\n              [ALMACEN_DESTINO],\n              [SUB_INVENTARIO_DESTINO],\n              [FECHA_TRANSACCION],\n              [NUMERO_ENVIO],\n              [QUERY_NAME],\n              [CREATE_DATE]\n       FROM   [QA_LANDING].[SERIESENTRANSITO])\n\n      DELETE FROM [QA_LANDING].[FALLBACK_REPORT]\n      WHERE  FILE_NAME LIKE 'SERIESENTRANSITO%'\n\n      INSERT INTO [QA_LANDING].[FALLBACK_REPORT]\n                  ([KEY],\n                   [VALUE],\n                   FILE_NAME,\n                   STOCK_INVENTORY_DATE,\n                   STATUS,\n                   CREATED_DATE,\n                   MODIFIED_DATE)\n      (SELECT DISTINCT 'SKU'       ENTITY,\n                       SSH.ID      NAME,\n                       SSH.FILE_NAME,\n                       CREATE_DATE STOCK_INVENTORY_DATE,\n                       0,\n                       [dbo].[ufn_GetLocalDate] (getdate()),\n                       [dbo].[ufn_GetLocalDate] (getdate())\n       FROM   [QA_LANDING].[TMP_STREAM_SERIALS_IN_TRANSIT] SSH\n              LEFT OUTER JOIN\n              [QA_LANDING].[PHYSICAL_RESOURCE_SPECIFICATION]\n              PT\n                           ON PT.STOCK_KEEPING_UNIT = Upper(TRIM(SSH.ID))\n       WHERE  PT.STOCK_KEEPING_UNIT IS NULL\n       UNION\n       SELECT DISTINCT 'SALES CHANNEL'      ENTITY,\n                       SSH.SOURCE_WAREHOUSE NAME,\n                       SSH.FILE_NAME,\n                       CREATE_DATE          STOCK_INVENTORY_DATE,\n                       0,\n                       [dbo].[ufn_GetLocalDate] (getdate()),\n                       [dbo].[ufn_GetLocalDate] (getdate())\n       FROM   [QA_LANDING].[TMP_STREAM_SERIALS_IN_TRANSIT] SSH\n              LEFT OUTER JOIN [QA_LANDING].[SALESCHANNEL] SC\n                           ON Substring(SC.NAME, 1, 3) =\n                              Substring(SSH.SOURCE_WAREHOUSE, 1, 3)\n       WHERE  SC.NAME IS NULL\n       UNION\n       SELECT DISTINCT 'SALES CHANNEL'           ENTITY,\n                       SSH.DESTINATION_WAREHOUSE NAME,\n                       SSH.FILE_NAME,\n                       CREATE_DATE               STOCK_INVENTORY_DATE,\n                       0,\n                       [dbo].[ufn_GetLocalDate] (getdate()),\n                       [dbo].[ufn_GetLocalDate] (getdate())\n       FROM   [QA_LANDING].[TMP_STREAM_SERIALS_IN_TRANSIT] SSH\n              LEFT OUTER JOIN [QA_LANDING].[SALESCHANNEL] SC\n                           ON Substring(SC.NAME, 1, 3) =\n                              Substring(SSH.DESTINATION_WAREHOUSE, 1, 3)\n       WHERE  SC.NAME IS NULL)\n\n      INSERT INTO [QA_LANDING].[FALLBACK_REPORT_ARCHIVED]\n      SELECT *\n      FROM   QA_LANDING.FALLBACK_REPORT \n\n      --se supone que se llenó de la que llenaste arriba \n      SET @result = 'success'\n\n      SELECT @result;\n  --COMMIT TRANSACTION     \n  END TRY\n\n  BEGIN CATCH\n      --  ROLLBACK TRANSACTION\n      SET @result='failure'\n      SET @code = (SELECT ERROR_NUMBER())\n      SET @state = (SELECT ERROR_STATE())\n      SET @message = (SELECT ERROR_MESSAGE())\n\t  set @stackTraceTxt = 0\n      TRUNCATE TABLE [QA_LANDING].[TEMP_ERROR_LOG]\n\n      INSERT INTO [QA_LANDING].[TEMP_ERROR_LOG]\n                  (CODE,\n                   STATE,\n                   MESSAGE,\n                   STACKTRACETXT,\n                   STATUS,\n                   TASKNAME)\n      -- VALUES (@code,@state ,@message ,@stackTraceTxt,@result,'ValidateDataSerialsOnTransit')\n      (SELECT @code,\n              @state,\n              @message,\n              @stacktracetxt,\n              @result,\n              'ValidateDataSerialsOnTransit')\n\n      INSERT INTO QA_LANDING.ERROR_LOG\n                  (CODE,\n                   STATE,\n                   MESSAGE,\n                   STACKTRACETXT,\n                   STATUS,\n                   TASKNAME,\n                   CREATED_DATE)\n      (SELECT CODE,\n              STATE,\n              MESSAGE,\n              STACKTRACETXT,\n              STATUS,\n              TASKNAME,\n              [dbo].[ufn_GetLocalDate] (getdate())\n       --revisar campo de tabla, esto devuelve un datetime no datetime2\n       FROM   [QA_LANDING].[TEMP_ERROR_LOG])\n  END CATCH\n\n    SELECT @result; \n\n\t  UPDATE dbo.gen_Logs SET FIN = [dbo].[ufn_GetLocalDate](GETDATE()) WHERE LogID = @logID\n\n\nGO",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "Landing",
				"poolName": "Landing"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}