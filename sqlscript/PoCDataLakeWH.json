{
	"name": "PoCDataLakeWH",
	"properties": {
		"content": {
			"query": "CREATE DATABASE sqllogicaldw;\n\nUSE sqllogicaldw\n\nCREATE EXTERNAL DATA SOURCE ExternalDataSourceDataLake\n\tWITH (\n\t\tLOCATION   = 'https://azuesdlsadl01.dfs.core.windows.net/raw' \n\t    );\n\n\nCREATE EXTERNAL FILE FORMAT SynapseParquetFormat\nWITH ( \n        FORMAT_TYPE = PARQUET\n     );\n\nCREATE SCHEMA LDW authorization dbo;\n\nCREATE MASTER KEY ENCRYPTION BY PASSWORD = 'DLeV202E#!';\n\nCREATE DATABASE SCOPED CREDENTIAL SynapseUserIdentity \nWITH IDENTITY = 'User Identity';\n\nALTER DATABASE sqllogicaldw COLLATE Latin1_General_100_BIN2_UTF8;\n\nCREATE VIEW LDW.vwSalesOrders\nAS\nSELECT *,\nCAST(fct.filepath(1) AS DATE) AS FilePathDate\nFROM \nOPENROWSET \n( \n    BULK 'General/datalakehouse/sourcedatapartitionsalesorder/OrderDatePartition=*/*.csv',\n    DATA_SOURCE = 'ExternalDataSourceDataLake',\n    FORMAT = 'CSV',\n    PARSER_VERSION = '2.0',\n    HEADER_ROW = TRUE,\n    FIELDTERMINATOR ='|'\n) AS fct\n\nselect * from LDW.vwSalesOrders--46\n\nSELECT YEAR(SO.OrderDate) AS OrderDateYear,\n        COUNT(SO.OrderDate) AS TotalOrderCount\nFROM LDW.vwSalesOrders SO\nGROUP BY YEAR(SO.OrderDate);\n\nSELECT COUNT(SO.OrderID) AS TotalOrderCount\nFROM LDW.vwSalesOrders SO\nWHERE SO.OrderDate = '2017-02-16'\n\nEXEC sys.sp_create_openrowset_statistics N'\n    SELECT OrderDate\nFROM \nOPENROWSET \n(\n    BULK ''General/datalakehouse/sourcedatapartitionsalesorder/*/*.csv'',\n    DATA_SOURCE = ''ExternalDataSourceDataLake'',\n    FORMAT = ''CSV'',\n    PARSER_VERSION = ''2.0'',\n    HEADER_ROW = TRUE,\n    FIELDTERMINATOR =''|''\n) AS fct\n'\n\nCREATE SCHEMA STG AUTHORIZATION dbo;\n\n--Create Parquet file format\nCREATE EXTERNAL FILE FORMAT SynapseParquetFormat\nWITH ( \n        FORMAT_TYPE = PARQUET\n     );\n\n--Customer\nCREATE EXTERNAL TABLE STG.DimCustomer\nWITH \n(\n  LOCATION = 'General/datalakehouse/conformed/dimensions/dimcustomer/01',\n  DATA_SOURCE = ExternalDataSourceDataLake,\n  FILE_FORMAT = SynapseParquetFormat\n) \nAS\nSELECT YEAR(SO.OrderDate) AS OrderDateYear,\n        COUNT(SO.OrderDate) AS TotalOrderCount\nFROM LDW.vwSalesOrders SO\nGROUP BY YEAR(SO.OrderDate);\n\nselect * from  STG.DimCustomer-- si cargo un archivo donde la vista lo lee la vista se actualiza pero la tabla que se crea con la vista no se actualiza\n\nCREATE EXTERNAL TABLE STG.DimDate\nWITH \n(\n  LOCATION = 'General/datalakehouse/conformed/dimensions/dimdate',\n  DATA_SOURCE = ExternalDataSourceDataLake,\n  FILE_FORMAT = SynapseParquetFormat\n) \nAS--no se actualiza\nSELECT CAST(DateKey AS INT) AS DateKey,\n        CAST(Date AS DATE) AS Date,\n        CAST(Day AS TINYINT) AS Day,\n        CAST(WeekDay AS TINYINT) AS WeekDay,\n        WeekDayName,\n        CAST(Month AS TINYINT) AS Month,\n        MonthName,\n        CAST(Quarter AS TINYINT) AS Quarter,\n        CAST(Year AS SMALLINT) AS Year\nFROM\nOPENROWSET \n(\n    BULK 'General/datalakehouse/sourcedatadim/datedim/*.csv',\n    DATA_SOURCE = 'ExternalDataSourceDataLake',\n    FORMAT = 'CSV',\n    PARSER_VERSION = '2.0',\n    HEADER_ROW = TRUE,\n    FIELDTERMINATOR ='|'\n) AS fct\n\nselect count(0) from STG.DimDate\n\nCREATE VIEW LDW.vwDimDate\nAS\nSELECT * FROM \nOPENROWSET \n(\n    BULK 'General/datalakehouse/conformed/dimensions/dimdate',\n    DATA_SOURCE = 'ExternalDataSourceDataLake',\n    FORMAT = 'Parquet'\n) AS fct\n\nselect count(0) from LDW.vwDimDate--si cargo archivos se actualiza la vista\n\nCREATE VIEW LDW.vwDimCustomer\nAS\nSELECT * FROM \nOPENROWSET \n(\n    BULK 'General/datalakehouse/conformed/dimensions/dimcustomer/*/',\n    DATA_SOURCE = 'ExternalDataSourceDataLake',\n    FORMAT = 'Parquet'\n) AS fct\n\nCREATE EXTERNAL TABLE STG.FactSales\nWITH \n(\n  LOCATION = 'General/datalakehouse/conformed/facts/factsales/initial',\n  DATA_SOURCE = ExternalDataSourceDataLake,\n  FILE_FORMAT = SynapseParquetFormat\n) \nAS\nSELECT * from LDW.vwDimCustomer\n\nCREATE VIEW LDW.vwFactSales\nAS\nSELECT * FROM \nOPENROWSET \n(\n    BULK 'General/datalakehouse/conformed/facts/factsales/initial',\n    DATA_SOURCE = 'ExternalDataSourceDataLake',\n    FORMAT = 'Parquet'\n) AS fct\n\nEXEC sp_describe_first_result_set N'SELECT * FROM LDW.vwDimDate';",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "sqllogicaldw",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}