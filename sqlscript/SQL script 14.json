{
	"name": "SQL script 14",
	"properties": {
		"content": {
			"query": "/****** Object:  StoredProcedure [QA_Landing].[VALIDATEDATASTOCKONHAND]    Script Date: 11/01/2023 09:50:21 a. m. ******/\nSET ANSI_NULLS ON\nGO\nSET QUOTED_IDENTIFIER ON\nGO\nALTER PROC [QA_Landing].[VALIDATEDATASTOCKONHAND] AS\n\n/******\n\n\n\nAutor: Abraham D. Sánchez bSide\nCreatedDate: 2022-10-12\nModifiedDate: 2022-10-12\nModifiedBy: Abraham D. Sánchez bSide\nDescription: Create SP VALIDATEDATASTOCKONHAND\n\n\n\n******/\n\n    DECLARE @logid AS BIGINT = CONVERT(VARCHAR(15),\n                               FORMAT(Getdate(), 'yyMMddHHmmssmmm'))\n\n    EXEC [DBO].[GEN_SPLOGINSERTS]\n      '03 VALIDATEDATASTOCKONHAND',\n      'Execute insert table VALIDATEDATASTOCKONHAND',\n      @logid\n\n    DECLARE @result        VARCHAR (5000) = '',\n            @code          INT,\n            @state         INT,\n            @message       NVARCHAR(4000),\n            @stacktracetxt INT\n\n  BEGIN TRY\n\n  TRUNCATE TABLE [QA_LANDING].[TMP_STREAM_STOCK_ON_HAND]\n  TRUNCATE TABLE[QA_LANDING].[TMP_STREAM_STOCK_ON_CHAINS]\n\n      INSERT INTO [QA_LANDING].[TMP_STREAM_STOCK_ON_HAND]\n                  ([ORGANIZATION_NAME],\n                   [SKU],\n                   [DESCRIPTION],\n                   [SUBINVENTORY],\n                   [LOCALIZER],\n                   [QUANTITY],\n                   [FILE_NAME],\n                   [CREATE_DATE])\n      (SELECT [NOMBRE_ORGANIZACION],\n              [CODIGO_EQUIPO],\n              [DESCRIPCION],\n              [SUB_INVENTARIO],\n              [LOCALIZADOR],\n              [CANTIDAD],\n              [QUERY_NAME],\n              [CREATE_DATE]\n       FROM   [QA_LANDING].[REPORTECANTIDADMANO])\n\n      INSERT INTO [QA_LANDING].[TMP_STREAM_STOCK_ON_HAND]\n                  ([ORGANIZATION_NAME],\n                   [SKU],\n                   [DESCRIPTION],\n                   [SUBINVENTORY],\n                   [LOCALIZER],\n                   [QUANTITY],\n                   [FILE_NAME],\n                   [CREATE_DATE])\n      (SELECT [NOMBRE_ORGANIZACION],\n              [CODIGO_EQUIPO],\n              [DESCRIPCION],\n              [SUB_INVENTARIO],\n              [LOCALIZADOR],\n              [CANTIDAD],\n              [QUERY_NAME],\n              [CREATE_DATE]\n       FROM   [QA_LANDING].[REPORTECANTIDADMANO2])\n\n      INSERT INTO [QA_LANDING].[TMP_STREAM_STOCK_ON_CHAINS]\n                  ([SKU],\n                   [ORGANIZATION],\n                   [QUANTITY],\n                   [SUBINVENTORY],\n                   [FILE_NAME],\n                   [CREATE_DATE])\n      (SELECT [SKU],\n              [ORGANIZACION],\n              [CANTIDAD],\n              [SUBINVENTORY],\n              [FILE_NAME],\n              [CREATE_DATE]\n       FROM   [QA_LANDING].[CADENAS])\n\n      DELETE FROM [QA_LANDING].[FALLBACK_REPORT]\n      WHERE  UPPER(FILE_NAME) LIKE 'REPORTECANTIDADMANO%'\n\n      DELETE FROM [QA_LANDING].[FALLBACK_REPORT]\n      WHERE  UPPER(FILE_NAME) LIKE 'Cadenas%'\n\n      DELETE  FROM [QA_LANDING].[FALLBACK_REPORT]\n      WHERE  UPPER(FILE_NAME) LIKE 'REPORTECANTIDADMANO2%'\n\n\t  -- TRUNCATE TABLE [QA_LANDING].[FALLBACK_REPORT] \n\n      INSERT INTO [QA_LANDING].[FALLBACK_REPORT]\n                  ([KEY],\n                   [VALUE],\n                   [FILE_NAME],\n                   [STOCK_INVENTORY_DATE],\n                   [STATUS],\n                   [CREATED_DATE],\n                   [MODIFIED_DATE])\n      (SELECT DISTINCT 'SALES CHANNEL'       ENTITY,\n                       SSH.ORGANIZATION_NAME NAME,\n                       SSH.FILE_NAME,\n                       CREATE_DATE           STOCK_INVENTORY_DATE,\n                       --Revisar si esto es suficiente o tenemos que colocarlo como SSH.CREATE_DATE\n                       0,\n                       [dbo].[ufn_GetLocalDate] (getdate()),\n                       [dbo].[ufn_GetLocalDate] (getdate())\n       FROM   [QA_LANDING].[TMP_STREAM_STOCK_ON_HAND] SSH\n              LEFT OUTER JOIN [QA_LANDING].[SALESCHANNEL] SC\n                           ON SC.NAME = SSH.ORGANIZATION_NAME\n       WHERE  SC.NAME IS NULL \n       UNION\n       SELECT DISTINCT 'SKU'       ENTITY,\n                       SSH.SKU     NAME,\n                       SSH.FILE_NAME,\n                       CREATE_DATE STOCK_INVENTORY_DATE,\n                       0,\n                       [dbo].[ufn_GetLocalDate] (getdate()),\n                       [dbo].[ufn_GetLocalDate] (getdate())\n       FROM   [QA_LANDING].[TMP_STREAM_STOCK_ON_HAND] SSH\n              LEFT OUTER JOIN [QA_LANDING].[PHYSICAL_RESOURCE_SPECIFICATION] PT\n                           ON PT.STOCK_KEEPING_UNIT = Upper(TRIM(SSH.SKU))\n       WHERE  PT.STOCK_KEEPING_UNIT IS NULL  \n       UNION\n       SELECT DISTINCT 'SALES CHANNEL'  ENTITY,\n                       SSH.ORGANIZATION NAME,\n                       SSH.FILE_NAME,\n                       CREATE_DATE      STOCK_INVENTORY_DATE,\n                       0,\n                       [dbo].[ufn_GetLocalDate] (getdate()),\n                       [dbo].[ufn_GetLocalDate] (getdate())\n       FROM   [QA_LANDING].[TMP_STREAM_STOCK_ON_CHAINS] SSH\n              LEFT OUTER JOIN [QA_LANDING].[SALESCHANNEL] SC\n                           ON SC.NAME = SSH.ORGANIZATION\n       WHERE  SC.NAME IS NULL\n       UNION\n       SELECT DISTINCT 'SKU'       ENTITY,\n                       SSH.SKU     NAME,\n                       SSH.FILE_NAME,\n                       CREATE_DATE STOCK_INVENTORY_DATE,\n                       0,\n                       [dbo].[ufn_GetLocalDate] (getdate()),\n                       [dbo].[ufn_GetLocalDate] (getdate())\n       FROM   [QA_LANDING].[TMP_STREAM_STOCK_ON_CHAINS] SSH\n              LEFT OUTER JOIN [QA_LANDING].[PHYSICAL_RESOURCE_SPECIFICATION] PT\n                           ON PT.STOCK_KEEPING_UNIT = Upper(TRIM(SSH.SKU))\n       WHERE  PT.STOCK_KEEPING_UNIT IS NULL) \n\n\t  -- TRUNCATE TABLE [QA_LANDING].[FALLBACK_REPORT_ARCHIVED] \n\n      INSERT INTO [QA_LANDING].[FALLBACK_REPORT_ARCHIVED]\n      SELECT *\n      FROM   QA_LANDING.FALLBACK_REPORT\n\n      SET @result = 'success'\n\n      SELECT @result;\n  END TRY\n\n  BEGIN CATCH\n      --ROLLBACK TRANSACTION\n      SET @result='failure'\n      SET @code = (SELECT ERROR_NUMBER())\n      SET @state = (SELECT ERROR_STATE())\n      SET @message = (SELECT ERROR_MESSAGE())\n      SET @stacktracetxt = 0\n\n      TRUNCATE TABLE [QA_LANDING].[TEMP_ERROR_LOG]\n\n      INSERT INTO [QA_LANDING].[TEMP_ERROR_LOG]\n                  (CODE,\n                   STATE,\n                   MESSAGE,\n                   STACKTRACETXT,\n                   STATUS,\n                   TASKNAME)\n      -- VALUES (@code, @state, @message, @stackTraceTxt, @result,'ValidateDataStockOnHand')\n      (SELECT @code,\n              @state,\n              @message,\n              @stacktracetxt,\n              @result,\n              'ValidateDataStockOnHand')\n\n      INSERT INTO QA_LANDING.ERROR_LOG\n                  (CODE,\n                   STATE,\n                   MESSAGE,\n                   STACKTRACETXT,\n                   STATUS,\n                   TASKNAME,\n                   CREATED_DATE)\n      (SELECT CODE,\n              STATE,\n              MESSAGE,\n              STACKTRACETXT,\n              STATUS,\n              TASKNAME,\n              [dbo].[ufn_GetLocalDate] (getdate())\n       FROM   [QA_LANDING].[TEMP_ERROR_LOG])\n  END CATCH\n\n    SELECT @result; \n\t  UPDATE dbo.gen_Logs SET FIN = [dbo].[ufn_GetLocalDate](GETDATE()) WHERE LogID = @logID\n\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "Landing",
				"poolName": "Landing"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}